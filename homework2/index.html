<!-- Sostituisci la tua intera card del cifrario con questo blocco -->
<div class="card" id="cipher-card">
  <h2>Output linguistici distinti</h2>
  <p>Inserisci un testo, cifra con uno shift, poi decodifica via brute force o con la migliore stima per Italiano ed English.</p>

  <textarea id="cipher-input" rows="6">Voglio bere il latte e poi guardare il browser in Italia.</textarea>

  <div class="button-group">
    <label>Shift: <input type="number" id="cipher-shift" value="3" min="0" max="25"></label>
    <button id="btn-encrypt">Encrypt</button>
    <button id="btn-bruteforce">Brute-force Decode</button>
    <button id="btn-decode-lang">Decode by Language</button>
  </div>

  <h4>Frequenze (cipher)</h4>
  <div id="cipher-bars"></div>

  <h3>Italiano</h3>
  <div class="lang-card">
    <div class="lang-meta">Stima shift: <span id="it-shift">-</span></div>
    <textarea id="it-decoded" rows="4" readonly></textarea>
  </div>

  <h3>English</h3>
  <div class="lang-card">
    <div class="lang-meta">Estimated shift: <span id="en-shift">-</span></div>
    <textarea id="en-decoded" rows="4" readonly></textarea>
  </div>

  <h3>Brute Force (26 tentativi)</h3>
  <details open>
    <summary>Mostra/Nascondi risultati</summary>
    <div id="brute-results" class="brute-list"></div>
  </details>
</div>

<style>
  .lang-card{background:rgba(255,255,255,0.04);border-radius:10px;padding:12px;margin-bottom:12px}
  .lang-meta{color:var(--muted);margin-bottom:6px}
  .bar-row{display:flex;align-items:center;gap:8px;margin:4px 0}
  .bar-label{width:28px;text-align:center;color:#cfd7df;font-weight:700}
  .bar-wrap{flex:1;height:18px;background:rgba(255,255,255,0.06);border-radius:5px;overflow:hidden}
  .bar-fill{height:100%;background:var(--bar-color)}
  .bar-value{width:40px;text-align:right;color:var(--number-color);font-weight:700}
  .brute-list .brute-row{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.07)}
  .shift-badge{min-width:54px;text-align:center;font-weight:800;background:rgba(125,211,252,0.25);color:#fff;border-radius:8px;padding:3px 6px}
  .decode-text{flex:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;background:rgba(0,0,0,0.2);padding:6px 8px;border-radius:6px}
</style>

<script>
/* ===== Utilities ===== */
const AZ = Array.from({length:26},(_,i)=>String.fromCharCode(65+i));

function countLetters(text){
  const c = Object.fromEntries(AZ.map(L=>[L,0]));
  for(const ch of text.toUpperCase()){
    if(ch>='A'&&ch<='Z') c[ch]++;
  }
  return c;
}
function sumCounts(c){ return Object.values(c).reduce((a,b)=>a+b,0); }

function rotateCounts(cipherCounts, shift){
  // countsPlain[i] = countsCipher[(i + shift) % 26]
  const out = Object.fromEntries(AZ.map(L=>[L,0]));
  for(let i=0;i<26;i++){
    const p = i; // plain index
    const c = (i + shift) % 26; // cipher index that maps to this plain
    const Lp = String.fromCharCode(65+p);
    const Lc = String.fromCharCode(65+c);
    out[Lp] = cipherCounts[Lc]||0;
  }
  return out;
}

function renderBars(counts, container){
  container.innerHTML='';
  const max = Math.max(1, ...Object.values(counts));
  for(const L of AZ){
    const v = counts[L]||0;
    const row=document.createElement('div'); row.className='bar-row';
    const lbl=document.createElement('div'); lbl.className='bar-label'; lbl.textContent=L;
    const wrap=document.createElement('div'); wrap.className='bar-wrap';
    const fill=document.createElement('div'); fill.className='bar-fill'; fill.style.width=(v/max*100)+'%';
    const val=document.createElement('div'); val.className='bar-value'; val.textContent=v;
    wrap.appendChild(fill); row.appendChild(lbl); row.appendChild(wrap); row.appendChild(val);
    container.appendChild(row);
  }
}

function caesarShift(text,shift){
  return text.split('').map(ch=>{
    const c=ch.charCodeAt(0);
    if(c>=65&&c<=90) return String.fromCharCode((c-65+shift+26)%26+65);
    if(c>=97&&c<=122) return String.fromCharCode((c-97+shift+26)%26+97);
    return ch;
  }).join('');
}

/* ===== Language profiles (percent) ===== */
const en = {A:8.2,B:1.5,C:2.8,D:4.3,E:12.7,F:2.2,G:2.0,H:6.1,I:7.0,J:0.15,K:0.77,L:4.0,M:2.4,N:6.7,O:7.5,P:1.9,Q:0.095,R:6.0,S:6.3,T:9.1,U:2.8,V:0.98,W:2.4,X:0.15,Y:2.0,Z:0.074};
const it = {A:11.74,B:0.92,C:4.5,D:3.73,E:11.79,F:1.01,G:1.65,H:0.64,I:10.14,J:0.02,K:0.02,L:6.51,M:2.51,N:6.88,O:9.83,P:3.05,Q:0.51,R:6.37,S:4.98,T:5.62,U:3.01,V:2.10,W:0.02,X:0.02,Y:0.02,Z:1.18};

/* ===== Chi-square score (lower is better) ===== */
function chiSquareScore(observedCounts, langProfile){
  const N = Object.values(observedCounts).reduce((a,b)=>a+b,0);
  if(N===0) return Number.POSITIVE_INFINITY;
  let s=0;
  for(const L of AZ){
    const obs = observedCounts[L]||0;
    const freq = langProfile[L]||0.0001; // evita divisione per zero
    const exp = N * (freq/100);
    s += (obs-exp)*(obs-exp)/(exp||1e-9);
  }
  return s;
}

/* ===== Best shift by language ===== */
function bestShiftByLang(cipherCounts, lang){
  const prof = lang==='italian'? it : en;
  let bestS = 0, bestScore = Number.POSITIVE_INFINITY;
  for(let s=0;s<26;s++){
    const plainCounts = rotateCounts(cipherCounts, s);
    const score = chiSquareScore(plainCounts, prof);
    if(score < bestScore){ bestScore = score; bestS = s; }
  }
  return bestS;
}

/* ===== UI wiring ===== */
(function(){
  const inputEl = document.getElementById('cipher-input');
  const shiftEl = document.getElementById('cipher-shift');
  const outEl   = document.getElementById('cipher-bars');
  const encEl   = document.getElementById('btn-encrypt');
  const bruteEl = document.getElementById('btn-bruteforce');
  const langEl  = document.getElementById('btn-decode-lang');
  const encText = document.getElementById('cipher-output'); // retro-compat se presente
  const itShift = document.getElementById('it-shift');
  const enShift = document.getElementById('en-shift');
  const itDec   = document.getElementById('it-decoded');
  const enDec   = document.getElementById('en-decoded');
  const bruteHost = document.getElementById('brute-results');

  function currentCipher(){
    const s = Number(shiftEl.value)||0;
    return caesarShift(inputEl.value, s);
  }

  function updateBarsForCipherText(cipher){
    renderBars(countLetters(cipher), outEl);
  }

  encEl.addEventListener('click', ()=>{
    const c = currentCipher();
    document.getElementById('en-decoded').value = '';
    document.getElementById('it-decoded').value = '';
    itShift.textContent = '-';
    enShift.textContent = '-';
    bruteHost.innerHTML = '';
    // mostra testo cifrato se vuoi accanto alle barre
    updateBarsForCipherText(c);
  });

  langEl.addEventListener('click', ()=>{
    const cipher = currentCipher();
    const counts = countLetters(cipher);
    const sIT = bestShiftByLang(counts, 'italian');
    const sEN = bestShiftByLang(counts, 'english');
    itShift.textContent = String(sIT);
    enShift.textContent = String(sEN);
    itDec.value = caesarShift(cipher, (26 - sIT)%26);
    enDec.value = caesarShift(cipher, (26 - sEN)%26);
    updateBarsForCipherText(cipher);
  });

  bruteEl.addEventListener('click', ()=>{
    const cipher = currentCipher();
    bruteHost.innerHTML='';
    for(let s=0;s<26;s++){
      const row=document.createElement('div'); row.className='brute-row';
      const badge=document.createElement('div'); badge.className='shift-badge'; badge.textContent='s='+s;
      const txt=document.createElement('div'); txt.className='decode-text'; txt.textContent=caesarShift(cipher,(26-s)%26);
      row.appendChild(badge); row.appendChild(txt);
      bruteHost.appendChild(row);
    }
  });

  // render iniziale (input non cifrato)
  updateBarsForCipherText(inputEl.value);
})();
</script>
