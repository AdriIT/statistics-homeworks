<script>
    // --- Esempio testo italiano per Cesare ---
    const sampleText = "oggi vado al mercato per comprare mele e arance perchÃ© mi piace mangiare frutta fresca ogni giorno";
    const sampleShift = 5; // shift di prova

    // --- Funzioni Cesare ---
    function caesarShiftChar(ch, shift) {
        const A = 'A'.charCodeAt(0);
        const a = 'a'.charCodeAt(0);
        const code = ch.charCodeAt(0);
        if (code >= A && code < A + 26) return String.fromCharCode((code - A + shift + 26) % 26 + A);
        if (code >= a && code < a + 26) return String.fromCharCode((code - a + shift + 26) % 26 + a);
        return ch;
    }

    function caesarEncrypt(text, shift) {
        return Array.from(text).map(ch => caesarShiftChar(ch, shift)).join('');
    }

    // --- Calcolo frequenze lettere ---
    function computeLetterCounts(text) {
        const A = 'A'.charCodeAt(0);
        const counts = {};
        for (let i = 0; i < 26; i++) counts[String.fromCharCode(A + i)] = 0;
        for (const ch of (text || '').toUpperCase()) {
            const code = ch.charCodeAt(0);
            if (code >= A && code < A + 26) counts[String.fromCharCode(code)]++;
        }
        return counts;
    }

    function normalizeFreqs(freqs) {
        const total = Object.values(freqs).reduce((a, b) => a + b, 0) || 1;
        const out = {};
        Object.keys(freqs).forEach(k => out[k] = freqs[k] / total);
        return out;
    }

    function rotateFreqs(freqs, shift) {
        const A = 'A'.charCodeAt(0);
        const out = {};
        for (let i = 0; i < 26; i++) out[String.fromCharCode(A + i)] = 0;
        Object.keys(freqs).forEach(k => {
            const idx = k.charCodeAt(0) - A;
            const newIdx = (idx + shift + 26) % 26;
            out[String.fromCharCode(A + newIdx)] = freqs[k];
        });
        return out;
    }

    function chiSquareDistance(obs, exp) {
        const eps = 1e-9;
        let sum = 0;
        Object.keys(exp).forEach(k => {
            const o = obs[k] || 0;
            const e = exp[k] || 0;
            sum += ((o - e) * (o - e)) / (e + eps);
        });
        return sum;
    }

    // --- Riferimenti frequenze ---
    const REF_FREQ = {
        italian: { A:0.117,B:0.009,C:0.045,D:0.037,E:0.117,F:0.011,G:0.016,H:0.006,I:0.101,J:0.001,K:0.001,L:0.065,M:0.025,N:0.068,O:0.098,P:0.03,Q:0.005,R:0.063,S:0.049,T:0.056,U:0.03,V:0.02,W:0.0003,X:0.0001,Y:0.0002,Z:0.011 },
        english: { A:0.0817,B:0.0149,C:0.0278,D:0.0425,E:0.127,F:0.0223,G:0.0202,H:0.0609,I:0.0697,J:0.0015,K:0.0077,L:0.0403,M:0.0241,N:0.0675,O:0.0751,P:0.0193,Q:0.001,R:0.0599,S:0.0633,T:0.0906,U:0.0276,V:0.0098,W:0.0236,X:0.0015,Y:0.0197,Z:0.0007 }
    };

    // --- Funzione auto-decode ---
    function autoDecode(cipher, lang) {
        const ref = REF_FREQ[lang];
        const obsCounts = computeLetterCounts(cipher);
        const obsFreq = normalizeFreqs(obsCounts);
        let best = {shift: 0, score: Infinity};
        for (let s = 0; s < 26; s++) {
            const rotated = rotateFreqs(obsFreq, -s);
            const score = chiSquareDistance(rotated, ref);
            if (score < best.score) best = {shift: s, score};
        }
        const guessedShift = (26 - best.shift) % 26;
        return caesarEncrypt(cipher, guessedShift);
    }

    // --- Funzione per visualizzare istogrammi lettere con numeri in bianco ---
    function renderLetterChart(counts, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        const entries = Object.entries(counts);
        const max = Math.max(...entries.map(e => e[1]), 1);
        const wrap = document.createElement('div');
        wrap.style.display = 'flex';
        wrap.style.flexDirection = 'column';
        wrap.style.gap = '4px';

        entries.forEach(([letter, value]) => {
            const row = document.createElement('div');
            row.style.display = 'flex';
            row.style.alignItems = 'center';
            const label = document.createElement('div');
            label.textContent = letter;
            label.style.width = '28px';
            label.style.fontWeight = '700';
            label.style.color = 'black'; // lettere in nero
            const barWrap = document.createElement('div');
            barWrap.style.flex = '1';
            barWrap.style.background = 'rgba(0,0,0,0.05)';
            barWrap.style.borderRadius = '4px';
            barWrap.style.margin = '0 8px';
            const bar = document.createElement('div');
            bar.style.height = '18px';
            bar.style.width = `${(value/max)*100}%`;
            bar.style.background = '#800020';
            bar.style.borderRadius = '4px';
            barWrap.appendChild(bar);
            const val = document.createElement('div');
            val.textContent = value;
            val.style.width = '48px';
            val.style.textAlign = 'right';
            val.style.color = 'white'; // numeri in bianco
            row.appendChild(label);
            row.appendChild(barWrap);
            row.appendChild(val);
            wrap.appendChild(row);
        });
        container.appendChild(wrap);
    }

    // --- Esecuzione esempio ---
    const encryptedText = caesarEncrypt(sampleText, sampleShift);
    document.getElementById('encrypted-output').textContent = encryptedText;

    const decodedIt = autoDecode(encryptedText, 'italian');
    const decodedEn = autoDecode(encryptedText, 'english');

    document.getElementById('decrypted-output').textContent =
        `Decoded Italian:\n${decodedIt}\n\nDecoded English:\n${decodedEn}`;

    renderLetterChart(computeLetterCounts(sampleText), 'literature-chart');
</script>
